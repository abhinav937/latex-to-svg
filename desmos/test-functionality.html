<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Desmos Functionality</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        #workflow-steps {
            max-height: 400px;
            font-family: Arial, sans-serif;
            font-size: 13px;
        }
        #workflow-steps pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        input[type="text"] {
            font-size: 14px;
        }
        .success {
            color: #155724;
            background: #d4edda;
        }
        .error {
            color: #721c24;
            background: #f8d7da;
        }
        .calculator-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
    <!-- Desmos API -->
    <script src="https://www.desmos.com/api/v1.11/calculator.js?apiKey=31195a6c30094b078067f9bec7e35526"></script>
    <!-- LLM Integration Scripts -->
    <script src="llm/llm-schema.js"></script>
    <script src="llm/llm-integration.js"></script>
    <script src="desmos.js"></script>
</head>
<body>
    <h1>üß™ Desmos Functionality Test</h1>

    <div class="test-section">
        <h2>1. Calculator Initialization</h2>
        <button onclick="testCalculatorInit()">Test Calculator Init</button>
        <div id="init-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Get Viewport Bounds</h2>
        <button onclick="testGetViewport()">Test Get Viewport</button>
        <div id="viewport-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Get Settings</h2>
        <button onclick="testGetSettings()">Test Get Settings</button>
        <div id="settings-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. Set Expression</h2>
        <button onclick="testSetExpression()">Test Set Expression</button>
        <div id="expression-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>5. Get Calculator Context</h2>
        <button onclick="testGetContext()">Test Get Context</button>
        <div id="context-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>6. Full Workflow Test (Prompt ‚Üí Graph)</h2>
        <div style="margin-bottom: 10px;">
            <input type="text" id="test-prompt-input" placeholder="Enter prompt (e.g., 'Plot y = x^2')" 
                   style="width: 70%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="testFullWorkflow()">Test Full Workflow</button>
        </div>
        <div style="margin-bottom: 10px;">
            <button onclick="testFullWorkflow('Plot y = x^2')">Test: y = x¬≤</button>
            <button onclick="testFullWorkflow('Plot sin(x) and cos(x)')">Test: sin & cos</button>
            <button onclick="testFullWorkflow('plot a sinwave with 50Hz frequency in red color and a blue color cos wave with 100Hz')">Test: Frequency Domain</button>
        </div>
        <div id="workflow-result" class="result"></div>
        <div id="workflow-steps" class="result" style="margin-top: 10px;"></div>
    </div>

    <div class="test-section">
        <h2>Desmos Calculator (Visual Result)</h2>
        <div id="calculator" class="calculator-container"></div>
    </div>

    <script>
        let calculator = null;

        // Initialize calculator
        document.addEventListener('DOMContentLoaded', function() {
            try {
                calculator = Desmos.GraphingCalculator(document.getElementById('calculator'), {
                    expressions: true,
                    settingsMenu: true,
                    zoomButtons: true,
                    allowComplex: true  // Enable Complex Mode toggle in settings menu
                });

                // Initialize Desmos config
                if (typeof DesmosConfig !== 'undefined' && typeof Desmos !== 'undefined') {
                    DesmosConfig.initialize();
                }

                console.log('Calculator initialized for testing');
                document.getElementById('init-result').innerHTML = '<span class="success">‚úÖ Calculator initialized successfully</span>';
            } catch (error) {
                console.error('Error initializing calculator:', error);
                document.getElementById('init-result').innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        });

        function testCalculatorInit() {
            const result = document.getElementById('init-result');
            if (calculator) {
                result.innerHTML = '<span class="success">‚úÖ Calculator is initialized</span>';
            } else {
                result.innerHTML = '<span class="error">‚ùå Calculator is not initialized</span>';
            }
        }

        function testGetViewport() {
            const result = document.getElementById('viewport-result');
            if (!calculator) {
                result.innerHTML = '<span class="error">‚ùå Calculator not initialized</span>';
                return;
            }

            try {
                let viewport = null;
                if (calculator.graphpaperBounds && calculator.graphpaperBounds.mathCoordinates) {
                    viewport = calculator.graphpaperBounds.mathCoordinates;
                }
                
                if (viewport) {
                    result.innerHTML = `<span class="success">‚úÖ Viewport retrieved:</span><br><pre>${JSON.stringify(viewport, null, 2)}</pre>`;
                } else {
                    result.innerHTML = '<span class="error">‚ùå Could not get viewport</span>';
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        }

        function testGetSettings() {
            const result = document.getElementById('settings-result');
            if (!calculator) {
                result.innerHTML = '<span class="error">‚ùå Calculator not initialized</span>';
                return;
            }

            try {
                let settings = null;
                if (calculator.settings) {
                    settings = {
                        showGrid: calculator.settings.showGrid,
                        showXAxis: calculator.settings.showXAxis,
                        showYAxis: calculator.settings.showYAxis,
                        xAxisLabel: calculator.settings.xAxisLabel,
                        yAxisLabel: calculator.settings.yAxisLabel,
                        degreeMode: calculator.settings.degreeMode,
                        polarMode: calculator.settings.polarMode
                    };
                }
                
                if (settings) {
                    result.innerHTML = `<span class="success">‚úÖ Settings retrieved:</span><br><pre>${JSON.stringify(settings, null, 2)}</pre>`;
                } else {
                    result.innerHTML = '<span class="error">‚ùå Could not get settings</span>';
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        }

        function testSetExpression() {
            const result = document.getElementById('expression-result');
            if (!calculator) {
                result.innerHTML = '<span class="error">‚ùå Calculator not initialized</span>';
                return;
            }

            try {
                calculator.setExpression({
                    id: 'test-expr',
                    latex: 'y = x^2',
                    color: '#2d70b3'
                });

                const expressions = calculator.getExpressions();
                const found = expressions.find(e => e.id === 'test-expr');
                
                if (found) {
                    result.innerHTML = `<span class="success">‚úÖ Expression set successfully:</span><br><pre>${JSON.stringify(found, null, 2)}</pre>`;
                } else {
                    result.innerHTML = '<span class="error">‚ùå Expression not found after setting</span>';
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        }

        function testGetContext() {
            const result = document.getElementById('context-result');
            if (!calculator) {
                result.innerHTML = '<span class="error">‚ùå Calculator not initialized</span>';
                return;
            }

            try {
                if (typeof getCalculatorContext === 'function') {
                    const context = getCalculatorContext();
                    if (context) {
                        result.innerHTML = `<span class="success">‚úÖ Context retrieved:</span><br><pre>${JSON.stringify(context, null, 2)}</pre>`;
                    } else {
                        result.innerHTML = '<span class="error">‚ùå Context is null</span>';
                    }
                } else {
                    result.innerHTML = '<span class="error">‚ùå getCalculatorContext function not found</span>';
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        }

        async function testLLMIntegration() {
            const result = document.getElementById('llm-result');
            if (!calculator) {
                result.innerHTML = '<span class="error">‚ùå Calculator not initialized</span>';
                return;
            }

            if (typeof llmIntegration === 'undefined') {
                result.innerHTML = '<span class="error">‚ùå LLM integration not loaded</span>';
                return;
            }

            try {
                result.innerHTML = '<span>‚è≥ Testing LLM API call...</span>';
                
                const testPrompt = "Plot y = x^2";
                const context = {
                    currentExpressions: [],
                    currentViewport: null,
                    currentSettings: null
                };

                const response = await llmIntegration.processPrompt(testPrompt, context);
                
                result.innerHTML = `<span class="success">‚úÖ LLM API call successful:</span><br><pre>${JSON.stringify(response, null, 2)}</pre>`;
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span><br><pre>${error.stack}</pre>`;
            }
        }

        async function testFullWorkflow(promptText = null) {
            const result = document.getElementById('workflow-result');
            const steps = document.getElementById('workflow-steps');
            
            // Get prompt from input or parameter
            const prompt = promptText || document.getElementById('test-prompt-input').value.trim();
            
            if (!prompt) {
                result.innerHTML = '<span class="error">‚ùå Please enter a prompt</span>';
                return;
            }

            if (!calculator) {
                result.innerHTML = '<span class="error">‚ùå Calculator not initialized</span>';
                return;
            }

            if (typeof llmIntegration === 'undefined' || typeof DesmosConverter === 'undefined') {
                result.innerHTML = '<span class="error">‚ùå LLM integration not loaded</span>';
                return;
            }

            // Clear previous results
            result.innerHTML = '';
            steps.innerHTML = '';

            try {
                // Step 1: Get current context
                steps.innerHTML += '<div style="margin: 5px 0;"><strong>Step 1:</strong> Getting calculator context...</div>';
                let viewport = null;
                let settings = null;
                
                try {
                    if (calculator.graphpaperBounds && calculator.graphpaperBounds.mathCoordinates) {
                        viewport = calculator.graphpaperBounds.mathCoordinates;
                    }
                    if (calculator.settings) {
                        settings = {
                            showGrid: calculator.settings.showGrid,
                            showXAxis: calculator.settings.showXAxis,
                            showYAxis: calculator.settings.showYAxis
                        };
                    }
                } catch (e) {
                    console.warn('Could not get context:', e);
                }

                const context = {
                    currentExpressions: calculator.getExpressions(),
                    currentViewport: viewport,
                    currentSettings: settings
                };
                steps.innerHTML += `<div style="margin: 5px 0; color: #28a745;">‚úÖ Context retrieved</div>`;

                // Step 2: Create request
                steps.innerHTML += '<div style="margin: 5px 0;"><strong>Step 2:</strong> Creating LLM request...</div>';
                const request = LLMRequestSchema.createRequest(prompt, context);
                steps.innerHTML += `<div style="margin: 5px 0; color: #28a745;">‚úÖ Request created: "${prompt}"</div>`;

                // Step 3: Call LLM API
                steps.innerHTML += '<div style="margin: 5px 0;"><strong>Step 3:</strong> Calling LLM API...</div>';
                result.innerHTML = '<span>‚è≥ Calling API...</span>';
                
                const llmResponse = await llmIntegration.processPrompt(prompt, context);
                steps.innerHTML += `<div style="margin: 5px 0; color: #28a745;">‚úÖ LLM response received</div>`;
                steps.innerHTML += `<div style="margin: 5px 0;"><pre style="font-size: 11px; max-height: 150px; overflow-y: auto;">${JSON.stringify(llmResponse, null, 2)}</pre></div>`;

                // Step 4: Validate response
                steps.innerHTML += '<div style="margin: 5px 0;"><strong>Step 4:</strong> Validating response...</div>';
                if (typeof LLMResponseSchema !== 'undefined') {
                    const validation = LLMResponseSchema.validate(llmResponse);
                    if (!validation.isValid) {
                        steps.innerHTML += `<div style="margin: 5px 0; color: #dc3545;">‚ö†Ô∏è Validation warnings: ${validation.errors.join(', ')}</div>`;
                    } else {
                        steps.innerHTML += '<div style="margin: 5px 0; color: #28a745;">‚úÖ Response validated</div>';
                    }
                }

                // Step 5: Normalize response
                steps.innerHTML += '<div style="margin: 5px 0;"><strong>Step 5:</strong> Normalizing response...</div>';
                const normalizedResponse = LLMResponseSchema.normalize(llmResponse);
                steps.innerHTML += '<div style="margin: 5px 0; color: #28a745;">‚úÖ Response normalized</div>';

                // Step 6: Clear calculator (optional)
                steps.innerHTML += '<div style="margin: 5px 0;"><strong>Step 6:</strong> Clearing calculator...</div>';
                calculator.setExpressions([]);
                steps.innerHTML += '<div style="margin: 5px 0; color: #28a745;">‚úÖ Calculator cleared</div>';

                // Step 7: Apply to calculator
                steps.innerHTML += '<div style="margin: 5px 0;"><strong>Step 7:</strong> Applying to calculator...</div>';
                const expressionIds = DesmosConverter.applyToCalculator(normalizedResponse, calculator);
                steps.innerHTML += `<div style="margin: 5px 0; color: #28a745;">‚úÖ Applied ${expressionIds.length} expression(s) to calculator</div>`;

                // Step 8: Verify expressions
                steps.innerHTML += '<div style="margin: 5px 0;"><strong>Step 8:</strong> Verifying expressions...</div>';
                const finalExpressions = calculator.getExpressions();
                steps.innerHTML += `<div style="margin: 5px 0; color: #28a745;">‚úÖ Calculator now has ${finalExpressions.length} expression(s)</div>`;

                // Success!
                result.innerHTML = `<span class="success">‚úÖ <strong>Workflow Complete!</strong></span><br>
                    <div style="margin-top: 10px;">
                        <strong>Prompt:</strong> "${prompt}"<br>
                        <strong>Expressions Created:</strong> ${expressionIds.length}<br>
                        <strong>Explanation:</strong> ${normalizedResponse.explanation || 'N/A'}<br>
                        <strong>Viewport:</strong> ${normalizedResponse.viewport ? JSON.stringify(normalizedResponse.viewport) : 'Default'}
                    </div>`;

                // Scroll to calculator
                document.getElementById('calculator').scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå <strong>Error:</strong> ${error.message}</span>`;
                steps.innerHTML += `<div style="margin: 5px 0; color: #dc3545;">‚ùå Error: ${error.message}</div>`;
                console.error('Workflow error:', error);
            }
        }
    </script>
</body>
</html>

